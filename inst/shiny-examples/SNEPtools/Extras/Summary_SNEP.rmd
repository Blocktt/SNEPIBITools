---
title: "Southeast New England Coastal Watershed Restoration Program (SNEP) Stream IBI Summary Report"
author: "`r Sys.getenv('USERNAME')`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  word_document:
    toc: yes
subtitle: Metric Scores and Values
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(results='asis', echo=FALSE, warning=FALSE, message = FALSE)
options(kableExtra.auto_format = FALSE)
# needed for trouble shooting
boo_DEBUG <- FALSE
if(boo_DEBUG==TRUE){
  # myConfig <- file.path(system.file(package="ContDataQC"), "extdata", "config.ORIG.R")
  # source(myConfig)
}## IF ~ boo_DEBUG ~ END
```

# INTRODUCTION
The following document is dynamic - it changes depending on the data input into the SNEP R Shiny Application. 

Please refer to the "Data File Information" section for general properties of the input dataset used to generate this report. 

Histograms in the "Plots" section will change depending on the input dataset. 

# DATA FILE INFORMATION
```{r data_file_info}
library(tidyr)
library(dplyr)  
  # Results File

  df_metval <- df_metval
  df_metsc <- df_metsc

  # df_metval <- read.csv("C:/Users/Ben.Block/OneDrive - Tetra Tech, Inc/GitHub/SNEP_results_metval.csv")
  # df_metsc <- read.csv("C:/Users/Ben.Block/OneDrive - Tetra Tech, Inc/GitHub/SNEP_results_metsc.csv")
  # 
  # Report Info
  myReportDate <- format(Sys.time(), '%Y-%m-%d %H:%M:%S')
  cat(paste("**Report Date:** " ,myReportDate, "\n\n", sep=""))
  myUser <- Sys.getenv("USERNAME")
  cat(paste("**Generated By:** ", myUser, "\n\n", sep=""))
  
  # Number of Samples
  myNumRecords <- nrow(df_metval)
  cat(paste("**Number of Records:** ", myNumRecords, "\n\n", sep=""))
  
  # Period of Record
  df_metval$COLLDATE <- as.Date(df_metval$COLLDATE, format = "%m/%d/%Y")
  POR <- paste(min(df_metval$COLLDATE)," to ", max(df_metval$COLLDATE), sep="")
  cat(paste("**Period of Record:** ", POR, sep="", collapse="\n\n"))
```

# SUMMARY TABLES
### The tables below summarize the data that were input into the R Shiny Application.
### Table 1. Number of sites by Index Narrative and Index Region. 
```{r Results_summary_table1, message=FALSE}
library(knitr)
library(tidyr)
library(dplyr)
library(flextable)

options(dplyr.summarise.inform = FALSE)

df_scores <- df_metsc
df_scores$counts <- rep(1)

# create a vector in the desired order
row_ord <- c("Exceptional", "Satisfactory", "Moderately Degraded", "Severely Degraded")

table1 <- df_scores %>% 
  group_by(Index_Nar, INDEX_REGION) %>% 
  summarize(counts = sum(counts)) %>% 
  pivot_wider(names_from = INDEX_REGION,
              values_from = counts) %>% 
  # mutate(Index_Nar = factor(Index_Nar, levels = row_ord)) %>% 
  arrange(Index_Nar) %>% 
  rename("Index Narrative" = Index_Nar,
         "Low Gradient IBI" = LowGradientIBI)

# create flextable for output 
# https://davidgohel.github.io/flextable/articles/layout.html
ftable1 <- flextable(table1)
ftable1 <- autofit(ftable1)
theme_booktabs(ftable1)

```

### Table 2. Index scores summary statistics by Index Region.
```{r Results_summary_table2, message=FALSE}
library(knitr)
library(tidyr)
library(readxl)
library(flextable)

scores_trim <- df_scores %>%
  select(INDEX_REGION, Index, counts)

table2_temp <- scores_trim %>%
  group_by(INDEX_REGION) %>%
  summarize(N = sum(counts),
            Min = round(min(Index), 1),
            q25 = round(quantile(Index, 0.25, na.rm = TRUE), 1),
            Med = round(median(Index, na.rm = TRUE), 1),
            q75 = round(quantile(Index, 0.75, na.rm = TRUE), 1),
            Max = round(max(Index),1))%>%
  rename("Index Region" = INDEX_REGION)

#state directories
table.dir <- "tables"
table.file <- "Instruction_Tables.xlsx"
IBI_tab.dir <- "IBI_data"

IBI_data <- read_excel(file.path(table.dir, table.file), sheet = IBI_tab.dir
                     , na = c("NA", ""), trim_ws = TRUE, skip = 0
                     , col_names = TRUE)

table2 <- rbind(table2_temp, IBI_data)

# create flextable for output 
# https://davidgohel.github.io/flextable/articles/layout.html
ftable2 <- flextable(table2)
ftable2 <- autofit(ftable2)
theme_booktabs(ftable2)

```


### Table 3. Metrics in the SNEP IBI, with scoring formulas. Trend is the direction of metric response with increasing stress.
```{r Results_summary_table_3}
library(readxl)
library(knitr)
library(flextable)

# state directories
table.dir <- "tables"
table.file <- "Instruction_Tables.xlsx"
tab3.dir <- "Back_table1"

table3 <- read_excel(file.path(table.dir, table.file), sheet = tab3.dir
                     , na = c("NA", ""), trim_ws = TRUE, skip = 0
                     , col_names = TRUE)

# create flextable for output 
# https://davidgohel.github.io/flextable/articles/layout.html
ftable3 <- flextable(table3)
ftable3 <- autofit(ftable3)
ftable3 <- set_table_properties(ftable3, width = .5, layout = "autofit")
theme_booktabs(ftable3)

```


# PLOTS
## Map of Sites in SNEP region
These are the sites that have been input into the R Shiny Application. 
```{r Results_Site_Map}
library(ggplot2)
##### Map of Sites
## Color palette
region.colors <- c("LowGradientIBI" = "#1f78b4")

## Map of MA
m1 <- ggplot(data = subset(map_data("state"), region %in% c("massachusetts", "rhode island", "connecticut"))) + 
            geom_polygon(aes(x=long, y=lat, group=group), fill="light gray", color="black") +
            coord_fixed(1.3)+
          labs(x= "Longitude",
               y= "Latitude")+
          theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")

## Add Points
m1 <- m1 + geom_point(data=df_metsc
                      , aes(LONG, LAT, color=INDEX_REGION), size = 2)

## Change colors
m1 <- m1 + scale_colour_manual(name="Index Region"
                               , values=region.colors)
## Print Plot
m1
```


## Overall Index Scores by Index Region
```{r Results_Index_Plot}
# Packages
library(ggplot2)
library(dplyr)

# Plot
region.colors <- c("LowGradientIBI" = "#1f78b4") # plot colors

# SNEP scores

LowGrad_data <- df_metsc %>% 
  filter(INDEX_REGION == "LowGradientIBI") %>% 
  select_if(~sum(!is.na(.)) > 0)
  
if(dim(LowGrad_data)[1]==0){
  cat("")
} else {
    p1 <- ggplot(LowGrad_data, aes(x = Index, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(x= "Scores",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
} # end if else statement
# Output

if(dim(LowGrad_data)[1]==0){
  cat("")
} else {
  p1
} # end if statement

```

## Metric Values Distribution by Index Region.
Note, metrics are calculated, by BioMonTools package, for all Index Regions even if not applicable.

```{r Results_Metric_Values_Plots}
##### METRIC VALUES LOOP

#create table of metric names

col_metabbrev <- c("pi_OET"
                   ,"pt_ffg_pred"
                   ,"pt_NonIns"
                   ,"pt_POET"
                   ,"pt_tv_toler"
                   ,"pt_volt_semi")

col_metscore <- c("SC_pi_OET"
                   ,"SC_pt_ffg_pred"
                   ,"SC_pt_NonIns"
                   ,"SC_pt_POET"
                   ,"SC_pt_tv_toler"
                   ,"SC_pt_volt_semi")

col_metnames <- c("% Odon., Ephem., Trich. indivs"
                  , "% Predator taxa"
                  , "% non-insect taxa"
                  , "% Plec., Odon., Ephem., Trich. taxa"
                  , "% tolerant taxa"
                  , "% semivoltine taxa")

df_metnames <- as.data.frame(cbind(col_metabbrev,col_metscore, col_metnames))
df_metnames <- df_metnames %>% 
  rename("Met_Names" = col_metnames,
         "Met_Scores" = col_metscore,
         "Met_Abbrev" = col_metabbrev)

# western highlands metrics
# for columns "ni_total" to ncol(df_metval)
LowGrad_metval <- df_metval %>% 
  filter(INDEX_REGION == "LowGradientIBI")

#start column
if(dim(LowGrad_metval)[1]==0){
  start_col <- 0
} else {
  start_col <- which(colnames(LowGrad_metval)=="pi_OET")
} # end start_col statement

#end column
if(dim(LowGrad_metval)[1]==0){
  end_col <- 0
} else {
  end_col <- ncol(LowGrad_metval)
} # end end_col statement

# CREATE PLOTS - only if data are present
if(start_col == 0 & end_col == 0){
  cat("")
} else {

  metval_cols <- colnames(LowGrad_metval[,start_col:end_col])

for(i in metval_cols){
  subset.data <- LowGrad_metval[,c("INDEX_REGION", i)]
  
  subset.data <- subset.data %>% 
    rename(Value = eval(i))
  
  subset.metnames <- df_metnames %>% 
    filter(Met_Abbrev == i)
    
  
  title <- paste0(subset.metnames$Met_Names)
  
  subset.data$INDEX_REGION <- as.factor(subset.data$INDEX_REGION)
  
  region.colors <- c("LowGradientIBI" = "#1f78b4")
  
  p3 <- ggplot(subset.data, aes(x = Value, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(title = title,
         x= "Metric Values",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
  
  print(p3)

} # END of Loop
} # end if else statement

```

## Metric Scores Distribution by Index Region. 
Only metrics applied within each region are plotted.

```{r Results_Metric_Scores_Plots}
##### METRIC SCORES LOOP
# WESTERN HIGHLANDS
# for columns "ni_total" to ncol(df_metval)
# start column
if(dim(LowGrad_data)[1]==0){
  start_col <- 0
} else {
  start_col <- which(colnames(LowGrad_data)=="SC_pi_OET")
} # end start_col statement

# end column
if(dim(LowGrad_data)[1]==0){
  end_col <- 0
} else {
  end_col <- which(colnames(LowGrad_data)=="SC_pt_volt_semi")
} # end end_col statement

# CREATE PLOTS - only if data are present
if(start_col == 0 & end_col == 0){
  cat("")
} else {
  metsc_cols <- colnames(LowGrad_data[,start_col:end_col])


for(i in metsc_cols){
  subset.data <- LowGrad_data[,c("INDEX_REGION", i)]
  
  subset.data <- subset.data %>% 
    rename(Value = eval(i))
  
  subset.metnames <- df_metnames %>% 
    filter(Met_Scores == i)
    
  
  title <- paste0("Met Score - ", subset.metnames$Met_Names)
  
  subset.data$INDEX_REGION <- as.factor(subset.data$INDEX_REGION)
  
  subset.data <- subset.data %>% filter(!is.na(Value))
  
  region.colors <- c("LowGradientIBI" = "#1f78b4")
  
  p5 <- ggplot(subset.data, aes(x = Value, fill = INDEX_REGION))+ 
    geom_histogram(alpha = 1, position = "dodge", bins = 20, color = "black")+
    labs(title = title,
         x= "Metric Scores",
         y= "Frequency",
         fill= "Index Region")+
    scale_fill_manual(values=region.colors)+
    theme(text = element_text(size = 12),
          axis.text = element_text(color = "black", size = 12),
          axis.text.x = element_text(angle = 0, hjust = 0.5),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.line = element_line(color = "black"),
          legend.position = "top")
  
  print(p5)

} # END of Loop
} # end if else statement

```
